# This play enables rsyslog disables syslog and makes a basic configuration.
# All subsequent play should put configuration into /etc/rsyslog.d/ and
# notify reload rsyslog.
# Format gluster disk:
# --extra-vars "format=yes"
# Mount gluster disk:
# --extra-vars "mount=yes"
---
- hosts: all
  vars_files:
    - gluster_vars.yml

  vars:
    is_master: "'$inventory_hostname' == '$master'"
    is_format: "'$format' == 'yes'"
    is_mount: "'$mount' == 'yes'"

  tasks:

  - name: Download Glusterfs repo
    get_url: url=${url}/${repo} dest=/etc/yum.repos.d/${repo}
    tags:
      - packages

  - name: Install Gluster server
    yum: name=glusterfs-server
         state=latest
    tags:
      - packages

  - name: Create Gluster partition
    lvol: vg=$vg_root
          lv=$lv_data
          size=$lv_size

  - name: Create XFS filesystem
    command: /sbin/mkfs.xfs -i size=512 /dev/${vg_root}/${lv_data}
    only_if: '$is_format'

  - name: Creat mount dir
    file: path=$lv_mnt
          state=directory

  - name: Create common dir
    file: path=$common
          state=directory

  - name: Mount Glusterfs
    mount: name=$lv_mnt
           src=/dev/${vg_root}/${lv_data}
           fstype=xfs
           state=mounted

  - name: Start Glusterfs
    service: name=glusterd
             state=started
             enabled=yes

# setfattr -x trusted.glusterfs.volume-id /data/glusterfs/common/brick1

  - name: Install Gluster bootstrap
    template: src=root/gluster_bootstrap.j2
              dest=/root/gluster_bootstrap
              owner=root
              group=root
              mode=0700
    ignore_errors: yes
    only_if: '$is_master'

# root-01> gluster peer probe root-03
# root-01> gluster volume add-brick common 10.1.1.3:/data/glusterfs/common/brick1
# root-01> gluster volume stop common
# root-01> gluster volume delete common

# lvremove /dev/vg_root/glusterfs_common_brick1
