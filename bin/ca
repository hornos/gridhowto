#!/bin/bash
gdn=$(pwd $(dirname $0))
gbn=$(basename $0)
inventory=./hosts
config=./config

base_dn="ou=Globus,o=Grid"

tmp=".${gbn}.$$"

ca_dir="./ca"

function ca/exit() {
  if test -r "${tmp}" ; then
    rm -f "${tmp}"
  fi
  exit 1
}
trap ca/exit INT TERM EXIT


function help/ca() {
  cat <<EOF

Usage: ca <cmd> <args>
          create CN [days] [email]
EOF
  exit 1
}


function ca/mkdir() {
  local _dir=${*}
  if ! test -d "${_dir}" ; then
    mkdir -v -p "${_dir}"
  fi
}

function ca/init() {
  ca/mkdir "${ca_dir}/grid-security"
}


function ca/hash() {
  openssl x509 -hash -noout < ${1:-cacert.pem}
}

function ca/subject() {
  local _cn=${1:-test}
  echo "cn=${_cn},ou=${_cn}-$(hostname),${base_dn}"
}



### args
cmd=${1:-create}
shift

export X509_CERT_DIR=grid-security

case "${cmd}" in
  ### Create CA
  create)
    ca_cn=${1:-rootca}
    shift
    days=${1:-365}
    shift
    email=${1}

    ca/init
 
    if [ ! -z "${email}" ] ; then
      email="-email ${email}"
    fi

    pushd "${ca_dir}"
    subject=$(ca/subject "${ca_cn}")
    grid-ca-create -dir "${ca_cn}" -subject "${subject}" -days ${days} ${email}

    ### certificates for the CA
    ca/mkdir "${ca_cn}/grid-security"

    ### install CA certificate into the global cert dir
    ca_hash=$(ca/hash ${ca_cn}/cacert.pem)
    tgz=globus_simple_ca_${ca_hash}.tar.gz
    if [ ! -r "${tgz}" ] ; then
      exit 1
    fi
    echo
    echo "Install ${ca_cn} (${ca_hash})"
    tar xvz --exclude debian --strip-components=1 \
            -C grid-security -f ${tgz}
    popd
    echo ""
  ;;

  ### Request user certificate
  user)
    ca_cn=${1:-rootca}
    shift
    user_id=${1:-test}
    shift
    user_cn=${1:-Test}
    shift
    opts=${*}

    pushd ${ca_dir}

    if [ ! -r ${ca_id}/cacert.pem ] ; then
      exit 1
    fi
    ca_hash=$(ca/hash ${ca_cn}/cacert.pem)

    grid-cert-request -dir "${ca_cn}/grid-security" \
    -prefix "${user_id}_" -ca "${ca_hash}" \
    -cn "${user_cn}" ${opts}

    popd
  ;;

  host)
    ca_cn=${1:-rootca}
    shift
    fqdn=${1:-localhost}
    shift
    opts=${*}

    pushd ${ca_dir}

    if [ ! -r ${ca_cn}/cacert.pem ] ; then
      exit 1
    fi
    ca_hash=$(ca/hash ${ca_cn}/cacert.pem)

    grid-cert-request -dir "${ca_cn}/grid-security" \
    -prefix "${fqdn}_" -ca "${ca_hash}" \
    -host "${fqdn}" ${opts}

    popd
  ;;

  service)
    ca_cn=${1:-rootca}
    shift
    fqdn=${1:-localhost}
    shift
    service=${1:-ldap}
    shift
    opts=${*}

    pushd ${ca_dir}

    if [ ! -r ${ca_cn}/cacert.pem ] ; then
      exit 1
    fi
    ca_hash=$(ca/hash ${ca_cn}/cacert.pem)

    grid-cert-request -dir "${ca_cn}/grid-security" \
    -prefix "${fqdn}_${service}_" -ca "${ca_hash}" \
    -host "${fqdn}" -service "${service}" ${opts}

    popd
  ;;

  req)
    pushd ${ca_dir}
    ca_cn=${1:-rootca}
    shift
    req=${1:-localhost}
    openssl req -noout -text -in "${ca_cn}/grid-security/${req}_cert_request.pem"
    popd
  ;;

  sign)
    ca_cn=${1:-rootca}
    shift
    req=${1:-localhost}
    pushd "${ca_dir}/${ca_cn}"
    grid-ca-sign -in "grid-security/${req}_cert_request.pem" -out "grid-security/${req}_cert.pem" -dir .
    popd
  ;;

  revoke)
    ca_cn=${1:-rootca}
    shift
    req=${1:-localhost}
    pushd "${ca_dir}/${ca_cn}"
    openssl ca -config grid-ca-ssl.conf -revoke "grid-security/${req}_cert.pem"
    popd
  ;;

  crl)
    ca_cn=${1:-rootca}
    pushd "${ca_dir}/${ca_cn}"
    ca_hash=$(ca/hash cacert.pem)
    openssl ca -config grid-ca-ssl.conf -gencrl > "${ca_hash}.crl"
    popd
  ;;

  help|*)
    help/ca
  ;;
esac
