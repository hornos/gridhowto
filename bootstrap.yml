# This is the main bootstrap file which you have to run at first.
#
# Generate administrator keys before bootstrapping:
#
#     mkdir keys
#     cd keys
#     ssh-keygen -b 2048 -C Administrator -f admin
#
#
---
- hosts: all

  vars_files:
    - bootstrap_vars.yml

  tasks:
### PACKAGES
    - name: Install python-simplejson
      raw: yum -y install python-simplejson
      when: ansible_os_family == "RedHat"
      tags:
        - packages

    - name: Install sudo
      yum: name=sudo
           state=installed
      when: ansible_os_family == "RedHat"
      tags:
        - packages


    - name: Install python-simplejson
      raw: apt-get -y install python-simplejson
      when: ansible_os_family == "Debian"
      tags:
        - packages

    - name: Install sudo
      apt: name=sudo
           state=installed
      when: ansible_os_family == "Debian"
      tags:
        - packages


### ADMIN USER
# centos debian gid mismatch: uucp vs wheel
    - name: Create wheel group
      group: name=wheel
             gid=14
             system=yes
      when: ansible_os_family == "Debian"
      tags:
        - wheel

    - name: Create administrator user {{ admin_user }}
      user: name={{ admin_user }}
            comment='Administrator'
            groups=wheel
            password=*
            shell=/bin/bash
      tags:
        - wheel

    - name: Sudoers for wheel
      lineinfile: dest=/etc/sudoers.d/wheel line="%wheel ALL=(ALL) NOPASSWD:ALL"
                  create=yes
                  state=present
                  regexp='^%wheel'
      tags:
        - sudoers

    - name: Sudoers file mode
      file: path=/etc/sudoers.d/wheel
            owner=root
            group=root
            mode=0440
      tags:
        - sudoers

    - name: Create admin SSH directory
      file: path=/home/{{ admin_user }}/.ssh
            state=directory
            owner={{ admin_user }}
            group={{ admin_user }}
            mode=0700
      tags:
        - ssh

    - name: Install admin SSH public key
      copy: src={{ admin_key }}.pub
            dest=/home/{{ admin_user }}/.ssh/authorized_keys
            owner={{ admin_user }}
            group={{ admin_user }}
            mode=0600
      tags:
        - ssh
