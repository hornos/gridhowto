# This is the main bootstrap file which you have to run at first.
#
# Generate administrator keys before bootstrapping:
#
#     mkdir keys
#     cd keys
#     ssh-keygen -b 2048 -C Administrator -f admin
#
#
---
- hosts: all

  vars_files:
    - bootstrap_vars.yml

  tasks:
    - name: Install python-simplejson
      raw: yum -y install python-simplejson
      tags:
        - packages

    - name: Install sudo
      yum: name=sudo
           state=installed
      tags:
        - packages

    - name: Create administrator user $admin_user
      user: name=$admin_user
            comment='Administrator'
            groups=wheel
            password=*
      tags:
        - wheel

    - name: Sudoers for wheel
      lineinfile: dest=/etc/sudoers.d/wheel
                  create=yes
                  state=present
                  regexp='^%wheel'
                  line="%wheel ALL=(ALL) NOPASSWD:ALL"
      tags:
        - sudoers

    - name: Sudoers file mode
      file: path=/etc/sudoers.d/wheel
            owner=root
            group=root
            mode=0440
      tags:
        - sudoers

    - name: Create Root Administrator SSH Directory
      file: path=/home/${admin_user}/.ssh
            state=directory
            owner=$admin_user
            group=$admin_user
            mode=0700
      tags:
        - ssh

    - name: Copy Root Administrator SSH keys
      copy: src=${admin_key}.pub
            dest=/home/${admin_user}/.ssh/authorized_keys
            owner=$admin_user
            group=$admin_user
            mode=0600
      tags:
        - ssh
