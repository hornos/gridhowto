---
- hosts: all

  tasks:
#  - name: Install syslog-ng packages
#    yum: name=$item
#         state=installed
#    with_items:
#      - syslog-ng
#      - syslog-ng-libdbi
#    tags:
#      - packages

  - name: Stop rsyslog
    service: name=rsyslog
             state=stopped
             enabled=no
    tags:
      - prepare
    ignore_errors: yes

  - name: Uninstall rsyslog for sure
    yum: name=rsyslog
         state=absent
    when: ansible_os_family == "RedHat"
    tags:
      - prepare

  - name: Uninstall rsyslog for sure
    apt: name=rsyslog
         state=absent
    when: ansible_os_family == "Debian"
    tags:
      - prepare


### REDHAT
  - name: Install umask repo
    template: src=etc/yum.repos.d/umask.repo.j2
              dest=/etc/yum.repos.d/umask.repo
              owner=root
              group=root
    when: ansible_os_family == "RedHat"
    tags:
      - repo
      - packages

  - name: Install syslog-ng packages
    yum: name=syslog-ng
         state=latest
         enablerepo=umask
    when: ansible_os_family == "RedHat"
    tags:
      - packages

  - name: Install syslog-ng-libdbi packages
    yum: name=syslog-ng-libdbi
         state=latest
         enablerepo=umask
    when: ansible_os_family == "RedHat"
    tags:
      - packages

### UBUNTU - precise
#  - name: Install Madhouse key
#    apt_key: url=https://packages.madhouse-project.org/debian/archive-key.txt
#             state=present
#    when: ansible_distribution == "Ubuntu"
#    tags:
#      - repo
#      - key
#
#  - name: Install Madhouse repo
#    apt_repository: repo='deb http://packages.madhouse-project.org/ubuntu precise syslog-ng-3.4'
#    when: ansible_distribution == "Ubuntu"
#    tags:
#      - repo
#      - packages

### CONFIGURATION
  - name: Install /etc/syslog-ng/syslog-ng.conf
    template: src=etc/syslog-ng/syslog-ng.conf.j2
              dest=/etc/syslog-ng/syslog-ng.conf
              owner=root
              group=root
              backup=yes
    tags:
      - config

  - name: Create /etc/syslog-ng/conf.d
    file: path=/etc/syslog-ng/conf.d
          owner=root
          group=root
          state=directory
    tags:
      - config


### DEBIAN -- TODO update 3.3
  - name: Enable /etc/syslog-ng/conf.d
    lineinfile: dest=/etc/syslog-ng/syslog-ng.conf
                regexp='include "conf.d";'
                insertafter='^filter f_console'
                line='include "conf.d";'
    when: ansible_distribution == "Debian"
    notify:
      - Restart syslog-ng
    tags:
      - config


### SERVICE
  - name: Start syslog-ng
    service: name=syslog-ng
             state=started
             enabled=yes

  handlers:
    - name: Restart syslog-ng
      service: name=syslog-ng
               state=restarted
