#
# Shorewall firewall ipset blacklist
#
# http://www.ipdeny.com/blog/blocking-country-ip-tables-using-our-data-blocks-and-ipset-utility/
# http://shorewall.net/blacklisting_support.htm
# http://www.shorewall.net/ipsets.html
#
# http://braindump.mrzesty.net/68.html
#
# TODO: dhcp from networks.yml
#
# reset ipset:
# --extra-vars "reset=yes"
#
# TODO: fix fooX ipset?
# TODO: ipset at init
#
---
- hosts: all

  vars_files:
    - networks.yml
    - shorewall_vars.yml

  vars:
    is_reset: "'$reset' == 'yes'"

  tasks:
  - name: Install ipset packages
    yum: name=$item
         state=installed
    with_items:
      - ipset
    when: ansible_os_family == "RedHat"
    tags:
      - packages

  - name: Reset ipset
    command: /usr/sbin/ipset x
    only_if: '$is_reset'
    tags:
      - fix

  - name: Reset fooX shit
    shell: for i in $(ipset -n -L | uniq | grep fooX); do ipset -exist x $i;done
    tags:
      - fix

  - name: Remove /var/lib/shorewall/ipset.save
    file: path=/var/lib/shorewall/ipset.save
          state=absent
    tags:
      - fix

  - name: Enable SAVE_IPSETS
    lineinfile: dest=/etc/shorewall/shorewall.conf
                regexp='^SAVE_IPSETS='
                line='SAVE_IPSETS=No'
    tags:
      - config

  - name: Disable DYNAMIC_BLACKLIST
    lineinfile: dest=/etc/shorewall/shorewall.conf
                regexp='^DYNAMIC_BLACKLIST='
                line='DYNAMIC_BLACKLIST=Yes'
    tags:
      - config

  - name: Install /root/bin/geoblock
    template: src=root/bin/${item}.j2
              dest=/root/bin/${item}
              owner=root
              group=root
              mode=0755
    with_items:
      - geoblock
      - ipset_reset

# TODO: rc.d based ipset blacklist

  - name: Download Geoblock blacklist
    command: /root/bin/geoblock blacklist "{{shorewall.blacklist}}"
    notify:
      - Restart shorewall
    tags:
      - blacklist

  - name: Download Geoblock whitelist
    command: /root/bin/geoblock whitelist "{{shorewall.whitelist}}"
    notify:
      - Restart shorewall
    tags:
      - whitelist

#  - name: Activate geoblock blacklist
#    lineinfile: dest=/etc/shorewall/blacklist
#                regexp='^\+geoblock'
#                line='+geoblock[src,dst]'
#                state=absent
#    tags:
#      - config
#      - geoblock
#    notify:
#      - Restart shorewall

  - name: Activate geoblock blacklist
    lineinfile: dest=/etc/shorewall/blacklist
                regexp='^\+blacklist'
                line='+blacklist[src,dst]'
                # state=absent
    tags:
      - config
    notify:
      - Restart shorewall

# TODO: rule-based blacklisting and whitelisting
# TODO: country names to id
# TODO: continent ipsets
# TODO: areas from the Hilbert-map
# http://internetcensus2012.bitbucket.org/hilbert.html

  handlers:
    - name: Restart shorewall
      service: name=shorewall
               state=restarted
